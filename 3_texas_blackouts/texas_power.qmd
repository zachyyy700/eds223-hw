---
title: "Homework 3: 2021 Texas Blackouts"
author: "Zach Loo"
date: "October 25, 2025"
format:
  html: 
    theme: pulse
    css: styles.css
editor: source
execute:
  warning: false
  message: false
  cache: true
---

# README {.no-theme}

<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 1em; background: #e2e2e2;">
{{< include README.md >}}
</div>


---

---

```{r}
# Load packages
library(terra)
library(tidyverse)
library(tmap)
library(kableExtra)
library(stars)
library(maptiles)
```

```{r}
# Load lights data
lights_07_1 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021038.h08v05.001.2021039064328.tif'))

lights_07_2 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021038.h08v06.001.2021039064329.tif'))

lights_16_1 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021047.h08v05.001.2021048091106.tif'))

lights_16_2 <- read_stars(here::here('data', 'VNP46A1', 'VNP46A1.A2021047.h08v06.001.2021048091105.tif'))

```

## 1.1 Night Light Intensity Before & After Storm 

```{r}
# Merge Feb 7th rasters
lights_07 <- st_mosaic(lights_07_1, lights_07_2)

# Merge Feb 16th rasters
lights_16 <- st_mosaic(lights_16_1, lights_16_2)
```

```{r}
# Create Houston bounding box
houston_bbox <- st_bbox(c(xmin = -96.5,xmax = -94.5, ymin = 29, ymax = 30.5),
                          crs = "EPSG:4326")

# CRS check before cropping
if (st_crs(houston_bbox) == st_crs(lights_07)){
  print("CRS Match. Ready to crop.")
} else {
  warning("Converting Houston bbox to lights CRS:\n", st_crs(lights_07))
  
  houston_bbox <- st_transform(houston_bbox, crs = st_crs(lights_07))
}

# Crop 07 raster
cropped_07 <- st_crop(lights_07, houston_bbox)
# Crop 16 raster
cropped_16 <- st_crop(lights_16, houston_bbox)
```

```{r fig.width=12, fig.height=5}
#| label: fig-beforeafter
#| fig-cap: "Comparison of Houston Lights Before & After the February 2021 Severe Winter Storm."

# Plot before & after maps
map_07 <- tm_shape(cropped_07) +
  tm_raster(col.scale = tm_scale_continuous(values = '-brewer.greys'),
            col.legend = tm_legend(show = FALSE)) +
tm_layout(title = "Houston lights before storm (Feb. 7th)",
          title.position = c(0.03, 1),
          title.color = "white")

map_16 <- tm_shape(cropped_16) +
  tm_raster(col.scale = tm_scale_continuous(values = '-brewer.greys'),
            col.legend = tm_legend(show = FALSE)) +
tm_layout(title = "Houston lights after storm (Feb. 16th)",
          title.position = c(0.03, 1),
          title.color = "white") +
tm_compass(position = c('left', 'bottom'),
           size = 3,
           text.size = 0.9,
           color.dark = 'grey50',
           text.color = 'white') +
tm_scalebar(position = c('left', 'bottom'),
            text.size = 0.8,
            color.dark = 'grey50',
            text.color = 'white')

tmap_arrange(map_07, map_16, nrow = 1)
```

## 1.2 Create blackout mask

```{r}
# Get raster difference
lights_diff <- cropped_16 - cropped_07
```

```{r}
# Create houston blackout mask
lights_diff[lights_diff > -200] <- NA
```

```{r}
# Vectorize mask
blackout_areas <- lights_diff |> 
  st_as_sf() |> 
  st_make_valid() |> 
  st_transform("EPSG:3083") # Re-project to new crs

# Rename first column name
colnames(blackout_areas)[1] <- "light_difference"
```


## 2. Exclude highways from blackout mask

```{r}
# Load roads data but only highways
roads <- st_read(here::here('data', 'gis_osm_roads_free_1.gpkg'), query = "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'", quiet = TRUE) |> 
  st_transform("EPSG:3083")
```

```{r}
# Create 200m buffer
roads_buffer <- st_buffer(roads, dist = 200)
```

```{r}
# Combine road geometries first
roads_buffer_union <- st_union(roads_buffer)

# CRS check before finding difference
if (st_crs(blackout_areas) == st_crs(roads_buffer_union)){
  print("CRS Match. Ready to find difference.")
} else {
  warning("Converting blackout_areas to roads CRS:\n", st_crs(roads_buffer_union))
  
  blackout_areas <- st_transform(blackout_areas, crs = st_crs(roads_buffer_union))
}

# Find areas NOT within buffer
blackout_far_areas <- st_difference(blackout_areas, roads_buffer_union)

```

## 3. Identify homes impacted by blackouts

```{r}
homes <- st_read(
  here::here("data", "gis_osm_buildings_a_free_1.gpkg"),
  query = "
    SELECT * FROM gis_osm_buildings_a_free_1
    WHERE (type IS NULL AND name IS NULL)
       OR type IN ('residential', 'apartments', 'house', 'static_caravan', 'detached')", quiet = TRUE) |> 
  st_transform("EPSG:3083")
```

```{r}
# CRS check before filtering
if (st_crs(homes) == st_crs(blackout_far_areas)){
  print("CRS Match. Ready to filter.")
} else {
  warning("Converting homes to blackout_far_areas CRS:\n", st_crs(blackout_far_areas))
  
  homes <- st_transform(homes, crs = st_crs(blackout_far_areas))
}

# Find homes in blackout areas
homes_blackout <- homes |> 
  st_filter(y = st_union(blackout_far_areas))

```

```{r fig.height=6, fig.width=7}
#| label: fig-blackout-homes
#| fig-cap: "Map of Homes That Lost Power."

tm_shape(blackout_far_areas) +
  tm_polygons(col = 'grey20', col_alpha = 0.5) +
  tm_basemap('CartoDB.VoyagerNoLabels') +
  tm_graticules(x = seq(-96.4, -94.8, 0.4),
                #y = seq(29.0, 30.4, 0.2),
                alpha = 0.2) +
  
tm_shape(homes_blackout) +
  tm_polygons(col = 'blue') +

tm_add_legend(labels = c("Blackout Areas, Excluding Highways", "Homes That Lost Power"),
              fill = c('grey20', 'blue'),
              type = 'polygons',
              position = c('left', 'top')) +


tm_layout(bg.color = 'grey90')
```

```{r}
# Table of homes that experienced blackouts
homes_df <- homes_blackout |> 
  group_by(type) |> 
  summarise(count = n(),
            percent = round((n() / nrow(homes_blackout)) * 100, digits = 2)) |>
  st_drop_geometry()

# Add total row
homes_df <- homes_df |> 
  add_row(type = 'Total', count = sum(homes_df$count)) 

# Change type NA to character string
homes_df$type[6] <- "NA"

```

```{r}
#| label: tbl-homes
#| tbl-cap: "Homes That Experienced Blackouts by Home Type"

# Display kable table
options(knitr.kable.NA = "")
kable(homes_df, 
      col.names = c("Home Type", "Count", "Percentage (%)"), align = 'c')

```

## 4. Census Tract Distribution

```{r}
# View layers in gdb file
#st_layers(here::here('data', 'ACS_2019_5YR_TRACT_48_TEXAS.gdb'))

# Extract income layer
income <- st_read(here::here('data', 'ACS_2019_5YR_TRACT_48_TEXAS.gdb'),
                  layer = 'X19_INCOME', quiet = TRUE) |> 
  dplyr::select(c(GEOID, B19013e1, B19013m1))

# Extract census tract layer
census <- st_read(here::here('data', 'ACS_2019_5YR_TRACT_48_TEXAS.gdb'),
                  layer = 'ACS_2019_5YR_TRACT_48_TEXAS', quiet = TRUE) |> 
  dplyr::select(-c(GEOID)) |> # Drop GEOID column
  rename(GEOID = GEOID_Data) |>  # Rename GEOID_Data for joining
  st_transform("EPSG:3083")
```

```{r}
# Find how many census tracts in houston bbox
houston_tracts_number <- census |> 
  st_crop(st_transform(houston_bbox, crs = "EPSG:3083")) |> 
  nrow()

paste0("Number of Houston census tracts: ", houston_tracts_number) 
```


```{r}
# Transform Houston bbox before joining
#houston_bbox <- st_transform(houston_bbox, crs = "EPSG:3083")

# CRS check before joining & cropping
if (st_crs(houston_bbox) == st_crs(census)){
  print("CRS Match. Ready to find difference.")
} else {
  warning("Converting houston_bbox CRS to census CRS:\n", st_crs(census))
  
  houston_bbox <- st_transform(houston_bbox, crs = st_crs(census))
}

# Join census & income data
census_income <- left_join(x = census, y = income, by = "GEOID") |> 
  st_crop(houston_bbox) |> 
  filter(ALAND != 0) |>  # Filter out ocean geometries
  dplyr::select(c("GEOID", "B19013e1", "B19013m1")) |> 
  rename(median_hh_income_est = B19013e1,
         median_hh_income_moe = B19013m1)
```

```{r}
# Filter to census tracts that lost power
census_blackouts <- census_income |>
  st_filter(y = blackout_far_areas, .predicate = st_intersects) |> 
  mutate(blackout = TRUE) # Add blackout column

# Create blackout GEOID for filtering census_income & joining later
blackout_ids <- census_blackouts$GEOID

# Print number of census tracts that experienced blackouts
paste0("Number of Houston census tracts that experienced blackouts: ", nrow(census_blackouts))
```

```{r}
#| label: fig-census-blackouts
#| fig-cap: "Houston Census Tracts That Lost Power."

# Plot blackout areas with census blackouts
tm_shape(census_income) + # Census layer
  tm_polygons() +
tm_shape(census_blackouts) + # Census blackout layer
  tm_polygons(fill = 'orange') +
  
tm_compass(position = c(0.92, 0.32)) +
tm_scalebar(position = c(0.76, 0.18)) +
tm_add_legend(labels = c("Tracts That Lost Power"),
              fill = c('orange'),
              type = 'polygons',
              position = c('right', 'bottom')) 
```

```{r}
# Create boolean column whether tract had a blackout or not
census_blackout_tf <- census_income |> 
  mutate(blackout = GEOID %in% blackout_ids)
```


```{r}
#| label: fig-income
#| fig-cap: "Distribution of Median Household Income for Census Tracts per Blackout Group."

# Median household income plot
ggplot(census_blackout_tf, aes(blackout, median_hh_income_est)) +
  geom_boxplot() +
  
  scale_x_discrete(labels = c('No Blackout', 'Blackout')) +
  labs(y = "Median Household Income (Estimate) in Census Tract") +
  
  theme_classic() +
  theme(panel.grid.major.y = element_line(color = 'grey'),
        axis.title.x = element_blank()) 
```


```{r}
# Get value counts for blackout column
table(census_blackout_tf$blackout)
```

It is documented that impacted census tracts did have lower median household income on average, indicating that low-income communities in Texas were disproportionately affected by the 2021 winter storm [(Lee et al. 2022)](https://pubmed.ncbi.nlm.nih.gov/36187845/). The boxplots in @fig-income don't show the expected results. 

## References

-   Román, M.O., Wang, Z., Sun, Q., Kalb, V.L., Miller, S.D., Molthan, A., Schultz, L., Bell, J., Stokes, E.C., Pandey, B., et al. (2018). NASA’s Black Marble nighttime lights product suite (VNP46). Remote Sensing of Environment, 210, 113-143. <https://doi.org/10.1016/j.rse.2018.03.017>

-   OpenStreetMap Contributors (2025). OpenStreetMap database. Retrieved from <https://www.openstreetmap.org>. Distributed by Geofabrik GmbH, Karlsruhe, Germany. Available at <https://download.geofabrik.de/>

-   U.S. Census Bureau. (2020). TIGER/Line Shapefiles and American Community Survey 2019 (5-Year Estimates), Texas — Census Tract Level (ACS_2019_5YR_TRACT_48_TEXAS) [Data set]. U.S. Department of Commerce. Available from <https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-data.html>

- Lee CC, Maron M, Mostafavi A. Community-scale big data reveals disparate impacts of the Texas winter storm of 2021 and its managed power outage. Humanit Soc Sci Commun. 2022;9(1):335. doi:10.1057/s41599-022-01353-8. Epub 2022 Sep 24. PMID: 36187845; PMCID: PMC9510185.
